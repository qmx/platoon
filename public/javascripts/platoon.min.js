/*! platoon - v0.1.0 - 2/5/2012
* https://github.com/rwldrn/platoon
* Copyright (c) 2012 Rick Waldron <waldron.rick@gmail.com>; Licensed MIT */
(function(a){var b=a.navigator,c=function(a){var c=b.getUserMedia||b.webkitGetUserMedia||b.oGetUserMedia,d=b.oGetUserMedia?{video:!0,audio:!0}:"video audio";c.call(b,d,function(b){var c=window.webkitURL?window.webkitURL.createObjectURL(b):b;a(c)})},d,e;d=function(a,b,e){var f;this.id=a,this.isMe=e,this.media=e?d.fixture("video",this.id):new Image,this.canvas=d.fixture("canvas",this.id),this.context=this.canvas.getContext("2d"),this.socket=b,e&&(f=function(a){this.media.src=a,this.media.addEventListener("loadedmetadata",function(){this.media.play()}.bind(this))}.bind(this),c(f)),this.throttle()},d.prototype.throttle=function(){requestAnimationFrame(function a(){this.draw(),requestAnimationFrame(a.bind(this))}.bind(this))},d.prototype.draw=function(){this.context.drawImage(this.media,0,0,280,160),this.isMe&&this.socket.emit("stream",{id:this.id,stream:this.canvas.toDataURL()})},d.id=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=Math.random()*16|0;return(a==="x"?b:b&3|8).toString(16)}).toUpperCase()},d.fixture=function(a,b){var c=document.createElement(a);return c.id=a[0]+"_"+b,c.style.width="160px",c.style.height="120px",document.body.appendChild(c),a==="video"&&(c.style.display="none"),c},d.exists=function(a){return!!document.querySelectorAll("[id$='"+a+"']").length},e={cache:{},socket:null,join:function(a){var b;b=localStorage.getItem("id"),b||(b=d.id(),localStorage.setItem("id",b)),this.socket=a,this.listen(),this.socket.emit("join",{id:b})},listen:function(){this.socket.on("joined",function(a){d.exists(a.id)||(this.cache[a.id]=new d(a.id,this.socket,localStorage.getItem("id")===a.id))}.bind(this)),this.socket.on("stream",function(a){var b=this.cache[a.id];!b&&!d.exists(a.id)&&(b=this.cache[a.id]=new d(a.id,this.socket,!1)),localStorage.getItem("id")!==a.id&&(b.media.src=a.stream)}.bind(this))}},a.Platoon=e,a.Unit=d})(typeof exports=="object"&&exports||this)