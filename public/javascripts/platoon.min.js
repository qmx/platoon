/*! platoon - v0.1.0 - 2/6/2012
* https://github.com/rwldrn/platoon
* Copyright (c) 2012 Rick Waldron <waldron.rick@gmail.com>; Licensed MIT */
(function(a){var b,c,d=["ms","moz","webkit","o"],e="";if(!a.requestAnimationFrame)while(d.length){e=d.pop(),b=a[e+"RequestAnimationFrame"],c=a[e+"CancelAnimationFrame"]||a[e+"CancelRequestAnimationFrame"];if(b)break}var f=a.navigator,g=function(a){var b=f.getUserMedia||f.webkitGetUserMedia||f.oGetUserMedia,c=f.oGetUserMedia?{video:!0,audio:!0}:"video audio";b.call(f,c,function(b){var c=window.webkitURL?window.webkitURL.createObjectURL(b):b;a(c)})},h,i;h=function(a,b,c){var d;this.id=a,this.isMe=c,this.media=c?h.fixture("video",this.id):new Image,this.canvas=h.fixture("canvas",this.id),this.context=this.canvas.getContext("2d"),this.dataUri="",this.socket=b,this.isDrawing=!1,c&&(d=function(a){this.media.src=a,this.media.addEventListener("loadedmetadata",function(){this.media.play()}.bind(this),!1),this.media.addEventListener("timeupdate",function(){this.draw(),this.broadcast()}.bind(this),!1)}.bind(this),g(d))},h.prototype.throttle=function(){},h.prototype.draw=function(){this.isDrawing=!0,this.context.drawImage(this.media,0,0,280,160),this.isDrawing=!1},h.prototype.broadcast=function(){this.isMe&&this.socket.emit("stream",{id:this.id,stream:this.canvas.toDataURL()})},h.id=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=Math.random()*16|0;return(a==="x"?b:b&3|8).toString(16)}).toUpperCase()},h.fixture=function(a,b){var c=document.createElement(a);return c.id=a[0]+"_"+b,c.style.width="160px",c.style.height="120px",document.body.appendChild(c),a==="video"&&(c.style.display="none"),c},h.exists=function(a){return!!document.querySelectorAll("[id$='"+a+"']").length},i={cache:{},socket:null,loop:null,join:function(a){var b;b=localStorage.getItem("id"),b||(b=h.id(),localStorage.setItem("id",b)),this.socket=a,this.listen(),this.socket.emit("join",{id:b}),function c(){var a=Object.keys(i.cache);a.length>1&&a.forEach(function(a){var b=this[a];!b.isMe&&!b.isDrawing&&(b.media.src=b.dataUri,b.draw())},i.cache),i.loop=setTimeout(c,250)}()},listen:function(){this.socket.on("joined",function(a){var b=a.id;h.exists(b)||(this.cache[b]=new h(b,this.socket,localStorage.getItem("id")===b))}.bind(this)),this.socket.on("disconnect",function(){c(i.loop)}),this.socket.on("stream",function(a){var b=a.id,c=this.cache[b];!c&&!h.exists(b)&&(c=this.cache[b]=new h(b,this.socket,!1)),localStorage.getItem("id")!==b&&(c.dataUri=a.stream)}.bind(this))}},a.Platoon=i,a.Unit=h})(typeof exports=="object"&&exports||this)