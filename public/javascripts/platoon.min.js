/*! platoon - v0.1.0 - 2/7/2012
* https://github.com/rwldrn/platoon
* Copyright (c) 2012 Rick Waldron <waldron.rick@gmail.com>; Licensed MIT */
(function(a){var b,c,d=["ms","moz","webkit","o"],e="",f="AnimationFrame";if(!a.requestAnimationFrame)while(d.length){e=d.pop(),b=a[e+"Request"+f],c=a[e+"Cancel"+f]||a[e+"CancelRequest"+f];if(b)break}var g=a.navigator,h=function(a){var b=g.getUserMedia||g.webkitGetUserMedia,c=g.getUserMedia?{video:!0,audio:!0}:"video audio";b.call(g,c,function(b){var c=window.webkitURL?window.webkitURL.createObjectURL(b):b;a(c)})},i,j;i=function(a,b,c){var d;this.id=a,this.isMe=c,this.media=c?i.fixture("video",this.id):new Image,this.canvas=i.fixture("canvas",this.id),this.context=this.canvas.getContext("2d"),this.dataUri="",this.socket=b,this.isDrawing=!1,c&&(d=function(a){this.media.src=a,this.media.addEventListener("loadedmetadata",function(){this.media.play()}.bind(this),!1),this.media.addEventListener("timeupdate",function(){this.draw(),this.broadcast()}.bind(this),!1)}.bind(this),h(d))},i.prototype.throttle=function(){},i.prototype.draw=function(){this.isDrawing=!0,this.context.drawImage(this.media,0,0,280,160),this.isDrawing=!1},i.prototype.broadcast=function(){this.isMe&&this.socket.emit("stream",{id:this.id,stream:this.canvas.toDataURL()})},i.id=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=Math.random()*16|0;return(a==="x"?b:b&3|8).toString(16)}).toUpperCase()},i.fixture=function(a,b){var c=document.createElement(a);return c.id=a[0]+"_"+b,c.style.width="160px",c.style.height="120px",document.body.appendChild(c),a==="video"&&(c.style.display="none"),c},i.exists=function(a){return!!document.querySelectorAll("[id$='"+a+"']").length},j={cache:{},socket:null,loop:null,join:function(a){var b;b=localStorage.getItem("id"),b||(b=i.id(),localStorage.setItem("id",b)),this.socket=a,this.listen(),this.socket.emit("join",{id:b}),function c(){var a=Object.keys(j.cache);a.length>1&&a.forEach(function(a){var b=this[a];!b.isMe&&!b.isDrawing&&(b.media.src=b.dataUri,b.draw())},j.cache),j.loop=setTimeout(c,1e3/6)}()},listen:function(){this.socket.on("joined",function(a){var b=a.id;i.exists(b)||(this.cache[b]=new i(b,this.socket,localStorage.getItem("id")===b))}.bind(this)),this.socket.on("disconnect",function(){c(j.loop)}),this.socket.on("stream",function(a){var b=a.id,c=this.cache[b];!c&&!i.exists(b)&&(c=this.cache[b]=new i(b,this.socket,!1)),localStorage.getItem("id")!==b&&(c.dataUri=a.stream)}.bind(this))}},a.Platoon=j,a.Unit=i})(typeof exports=="object"&&exports||this)